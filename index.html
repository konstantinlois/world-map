<!DOCTYPE html>
<html>
<head>

	<title>Quick Start - Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="./leaflet-event-forwarder.js"></script>

    <script src="states_provinces.json"></script>
    <script src="countries.json"></script>
		<script src="cities.json"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
						background: #9999FF;
        }

				.info {
					color: #ffffff;
				}

				#quiz {
					position:absolute;
				  top:100px;
					left: 10px;
					z-index: 1000;
				}

				#details {
					position:absolute;
				  top:270px;
					left: 10px;
					z-index: 1000;
					color: #ffffff;
				}
    </style>

</head>
<body>



<div id="map" style="width: 100%; height: 100%;"></div>

<div id="quiz">

<select name="countries" id="countries" onchange="countrySelected()">
</select>
<br>

<button id="next-button" onclick="nextCountry();">Next Country</button>
<form onsubmit="checkCountryName(event);">
	<input id="country-name" type="text">
	<button id="check-country-name-button" type="submit">Check</button>
</form>

<button id="next-button" onclick="nextState();">Next State</button>
<form onsubmit="checkStateName(event);">
	<input id="state-name" type="text">
	<button id="check-state-name-button" type="submit">Check</button>
</form>

<button id="next-button" onclick="nextCity();">Next City</button>
<form onsubmit="checkCityName(event);">
	<input id="city-name" type="text">
	<button id="check-city-name-button" type="submit">Check</button>
</form>

</div>

<div id="details">
	<p id="details-country">Test</p>
	<p id="details-state">Test</p>
	<p id="details-city">Test</p>
</div>

<script type="text/javascript">

	var map = L.map('map').setView([37.8, -96], 4);

	L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
		maxZoom: 16
	}).addTo(map);

	var layerGroupCountries = L.featureGroup([]).addTo(map);
	var layerGroupStates = L.featureGroup([]).addTo(map);
	var layerGroupCities = L.featureGroup([]).addTo(map);

	showCountries();

	// Details

	var currentCountry;
	var currentState;
	var currentCity;

	function updateDetails(){
		var detailsCountry = document.getElementById('details-country');
		detailsCountry.innerHTML = currentCountry != undefined ? currentCountry.feature.properties.NAME_EN : 'none';

		var detailsState = document.getElementById('details-state');
		detailsState.innerHTML = currentState != undefined ? currentState.feature.properties.name : 'none';

		var detailsCity = document.getElementById('details-city');
		detailsCity.innerHTML = currentCity != undefined ? currentCity.feature.properties.name_en : 'none';
	}

	// Countries

	function showCountries(){
		layerGroupCountries.eachLayer(function(layer) { layerGroupCountries.removeLayer(layer);});
		var layerCountries = L.geoJSON(countries[0].features, {
			style: styleCountry,
			//filter: function(f){ return f.properties.geonunit === countryLayer.feature.properties.NAME_EN },
			onEachFeature: onEachCountry
		});
		layerGroupCountries.addLayer(layerCountries);
	}

	function styleCountry(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: '#003839',
			//dashArray: '3',
			fillOpacity: 0.0,
			//fillColor: '#6abf69'
		};
	}

	function onEachCountry(feature, layer) {
		layer.on({
			//mouseover: highlightFeatureCountries,
			//mouseout: resetHighlightCountries,
			click: selectCountry
		});
	}

	function selectCountry(e){
		var layer = e.target;
		if(currentCountry == layer){
			return;
		}else{
			currentState = undefined;
			currentCity = undefined;
		}
		if(currentCountry != undefined){
			resetHighlightCountry(currentCountry);
		}
		currentCountry = layer;
		highlightCountry(layer);
		updateDetails();

		/*var selectBox = document.getElementById("countries");
    var selectedValue = selectBox.options[selectBox.selectedIndex].value;*/

		showStates(layer);
		showCities(layer);

		map.fitBounds(layerGroupStates.getBounds());
	}

	function highlightCountry(layer) {
		layer.setStyle({
			weight: 4,
			color: '#222222',
			dashArray: '',
			fillOpacity: 0.0
		});

		/*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}*/
	}

	function resetHighlightCountry(layer) {
		layerCountries.resetStyle(layer);
	}

	function zoomToCountry(e) {
		map.fitBounds(e.target.getBounds(), {padding: [50, 50]});
	}

	// States and Provinces

	function showStates(countryLayer){
		layerGroupStates.eachLayer(function(layer) { layerGroupStates.removeLayer(layer);});
		var layerStates = L.geoJSON(states[0].features, {
			style: styleState,
			filter: function(f){ return f.properties.geonunit === countryLayer.feature.properties.NAME_EN },
			onEachFeature: onEachState
		});
		layerGroupStates.addLayer(layerStates);
	}

	function styleState(feature) {
		return {
			weight: 1,
			//opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.0,
			//fillColor: '#6abf69'
		};
	}

	function onEachState(feature, layer) {
		layer.on({
			//mouseover: highlightFeature,
			//mouseout: resetHighlight,
			click: selectState
		});
	}

	function selectState(e){
		if(currentState != undefined){
			resetHighlightState(currentState);
		}
		var layer = e.target;
		currentState = layer;
		highlightState(layer);
		updateDetails();
	}

	function highlightState(layer) {
    //layer = e.target;
		layer.setStyle({
			weight: 5,
			color: '#81d4fa',
			dashArray: '',
			fillOpacity: 0.0
		});

		/*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}*/
	}

  function resetHighlightState(layer) {
		layerGroupStates.eachLayer(function (l) {
    	l.resetStyle(layer);
		});
	}

	function zoomToState(layer) {
		map.fitBounds(layer.getBounds(), {padding: [300, 300]});
	}

	// Cities

	function showCities(countryLayer){
		layerGroupCities.eachLayer(function(layer) { layerGroupCities.removeLayer(layer);});
		var layerCities = L.geoJSON(cities[0].features, {
			pointToLayer: function(feature, latlng) {
       	/*return new L.CircleMarker(latlng, {
		 			radius: 1,
		 			weight: 0.000005 * feature.properties.POP_MIN,
		 			//opacity: 1,
		 			color: '#e64a19',
		 			fillOpacity: 0.0
		 			//fillColor: '#6abf69'
	 			});*/
				return new L.marker(latlng, {
					icon: getCityIcon(feature),
				});
      },
			onEachFeature: onEachCity,
			filter: function(f){ return f.properties.ADM0NAME === countryLayer.feature.properties.NAME_EN && f.properties.RANK_MIN > 5 }
		});
		layerGroupCities.addLayer(layerCities);
	}

	function onEachCity(feature, layer) {
		layer.on({
			click: selectCity
		});
	}

	function selectCity(e){
		if(currentCity != undefined){
			resetHighlightCity(currentCity);
		}
		var layer = e.target;
		currentCity = layer;
		highlightCity(layer);
		updateDetails();
	}

	function highlightCity(layer) {
    //layer = e.target;
		/*layer.setStyle({
			weight: 8,
			radius: 1,
			color: '#81d4fa',
			dashArray: '',
			fillOpacity: 0.0
		});*/

		layer.setIcon(new L.Icon({
		  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
		  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor:   [12 ,41],
		  popupAnchor: [1, -34],
		  shadowSize: [41, 41]
		}));

		/*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}*/
	}

  function resetHighlightCity(layer) {
		layerGroupCities.eachLayer(function (l) {
    	//l.resetStyle(layer);

			layer.setIcon(getCityIcon(layer.feature));
		});
	}

	function getCityIcon(feature){
		return new L.Icon.Default({
			iconSize: [25, 41],
			iconAnchor:   [12, 41]
		})
	}

	// Country Selection

	var x = document.getElementById("countries");

	var countries = new Set();

	for (var i in states[0].features) {
		var feature = states[0].features[i];

		if(!countries.has(feature.properties.geonunit)){
			var opt = document.createElement('option');
			opt.value = feature.properties.geonunit;
			opt.innerHTML = feature.properties.geonunit;
			x.add(opt);

			countries.add(feature.properties.geonunit);
		}
	}

	// Quiz

	// Country Quiz

	function checkCountryName(event) {
			event.preventDefault();
			if(currentCountry.feature.properties.NAME_EN == document.getElementById("country-name").value){
				alert('correct');
				document.getElementById("state-name").value = "";
				nextCountry();
			}else{
				alert('wrong');
			}
	}

	function nextCountry(){
		if(currentCountry != undefined){
			resetHighlightCountry(currentCountry);
		}

		var values = [];
		layerGroupStates.eachLayer(function (layer) {
			layer.eachLayer(function(layer2) {
  			values.push(layer2);
			});
		});

		if(values.length > 0){
			var randomValue = currentState;
			do{
				randomValue = values[parseInt(Math.random() * values.length)]
			}while(values.length > 1 && randomValue == currentState)

			currentState = randomValue;
			highlightState(randomValue);
			updateDetails();
		}
	}

	// State Quiz

	function checkStateName(event) {
			event.preventDefault();
			if(currentState.feature.properties.name == document.getElementById("state-name").value){
				alert('correct');
				document.getElementById("state-name").value = "";
				nextState();
			}else{
				alert('wrong');
			}
	}

	function nextState(){
		if(currentState != undefined){
			resetHighlightState(currentState);
		}

		var values = [];
		layerGroupStates.eachLayer(function (layer) {
			layer.eachLayer(function(layer2) {
  			values.push(layer2);
			});
		});

		if(values.length > 0){
			var randomValue = currentState;
			do{
				randomValue = values[parseInt(Math.random() * values.length)]
			}while(values.length > 1 && randomValue == currentState)

			currentState = randomValue;
			highlightState(randomValue);
			updateDetails();
		}
	}

	// City Quiz

	function checkCityName(event) {
			event.preventDefault();
			if(currentCity.feature.properties.NAME == document.getElementById("city-name").value){
				alert('correct\npopulation: ' + currentCity.feature.properties.POP_MAX);
				document.getElementById("city-name").value = "";
				nextCity();
			}else{
				alert('wrong');
			}
	}

	function nextCity(){
		if(currentCity != undefined){
			resetHighlightCity(currentCity);
		}

		var values = [];
		layerGroupCities.eachLayer(function (layer) {
			layer.eachLayer(function(layer2) {
  			values.push(layer2);
			});
		});

		if(values.length > 0){
			var randomValue = currentCity;
			do{
				randomValue = values[parseInt(Math.random() * values.length)]
			}while(values.length > 1 && randomValue == currentCity)

			currentCity = randomValue;
			highlightCity(randomValue);
			updateDetails();
		}
	}

	// General

	/*function updateInfo(e){
		layer = e.target;
		info.update(layer.feature.properties);
		highlightState(e);
	}*/

	const myEventForwarder = new L.eventForwarder({
	  // ref to leaflet map
	  map: map,
	  // events to forward
	  events: {
	    click: true,
	    mousemove: true,
	    mouseout: true
	  },
	  // throttle options for mousemove events (same as underscore.js)
	  throttleMs: 100,
	  throttleOptions: {
	    leading: true,
	    trailing: false
	  }
	});

	myEventForwarder.enable();

	map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');

</script>



</body>
</html>
