<!DOCTYPE html>
<html>

<head>

    <title>World Map</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="./leaflet-event-forwarder.js"></script>

    <script src="https://tyrasd.github.io/osmtogeojson/osmtogeojson.js"></script>

    <link rel="stylesheet" href="style.css">

    <script src="countries.json"></script>

</head>

<body>



    <div id="map" style="width: 100%; height: 100%;"></div>

    <div id="top-bar">
        <p id="menu-button-open" onclick="toggleMenu()">☰</p>
    </div>

    <div id="menu">

        <div class="test">

        </div>

        <div id="menu-button-close" onclick="toggleMenu()">✕</div>

        <div id="menu-content">
            <br></br>
            <br>

            <div id="regions">
                <h2 class="collapsible-button menu-section-heading">Selected Regions</h2>
                <div class="collapsible-content">
                    <div class="menu-section-content">
                        <h4 class="menu-sub-section-heading">Countries</h4>
                        <div id="controls-countries">
                        </div>
                        <br>
                        <button onclick="selectCountries(function(layerCountry){return true;})">Select All</button>
                        <button onclick="unselectCountries(function(layerCountry){return true;})">Unselect All</button>
                    </div>
                </div>
            </div>

            <div id="controls">
                <h2 class="collapsible-button menu-section-heading">Controls</h2>
                <div id="controls-content" class="collapsible-content">
                    <div class="menu-section-content">
                        <h4 class="menu-sub-section-heading">Geographical Infos</h4>
                        <div id="controls-info-types">
                        </div>
                        <br>
                        <h4 class="menu-sub-section-heading">Indicators</h4>
                        <div id="controls-info-country-indicators">
                        </div>
                        <select id="controls-info-country-indicator-on-map" onchange="indicatorOnMapChanged()">
                            <option value="">None</option>
                        </select>
                        <br></br>
                        <button onclick="toggleIndicatorColors()">Toggle colors</button>
                    </div>
                </div>
            </div>

            <div class="quiz-setup">
                <h2 class="collapsible-button menu-section-heading">Quiz</h2>
                <div id="quiz-setup-content" class="collapsible-content">
                    <div class="menu-section-content">
                        <h4 class="menu-sub-section-heading">Question Types</h4>
                        <div id="quiz-setup-question-types">
                            <label><input type="checkbox" name="quiz-setup-question-type" value="country-name" /> Country
                                Name</label>
                            <label><input type="checkbox" name="quiz-setup-question-type" value="country-population" />
                                Country Population</label>
                        </div>
                        <br>
                        <h4 class="menu-sub-section-heading">Indicators</h4>
                        <div id="quiz-setup-country-indicators">
                        </div>
                        <br>
                        <button onclick="startQuiz()">Start</button>
                        <br></br>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-panel">
        <div id="quiz-panel-button-close" onclick="finishQuiz()">✕</div>
        <div id="quiz-panel-question-content">
            <h4 id="quiz-panel-question"></h4>
        </div>
        <div id="quiz-panel-question-evaluation">
            <h4 id="quiz-panel-question-evaluation-right-wrong"></h4>
            <p id="quiz-panel-question-evaluation-infos"></p>
        </div>
        <form onsubmit="questionPanelSubmitButtonClicked(event)">
            <div id="quiz-panel-form-container">
                <div id="quiz-panel-input-container">
                    <input id="quiz-panel-input" type="text" autocomplete="off" onfocus="checkResizeMap(true)" onfocusout="checkResizeMap(false)">
                </div>
                <button id="quiz-panel-submit-button" type="submit">Submit</button>
            </div>
        </form>
    </div>

    <div id="details">
        <div id="details-content">
            <div id="details-button-close" onclick="unselectCountry(currentCountry)">✕</div>
            <div id="details-country-container">
                <h4 class="details-heading">Country</h4>
                <p id="details-country"></p> <button id="details-country-add-remove" onclick="clickAddRemoveCountryButton()">Add</button>
            </div>
            <div id="details-feature-collections">
            </div>
            <div id="details-country-indicators">
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var map = L.map('map', {
            zoomControl: false
        }).setView([37.8, -96], 4);

        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16
        }).addTo(map);

        var featureCollections = {
            roads: {
                name: "Roads",
                nameSingular: "Road",
                zIndex: 1015,
                style: {
                    normal: {
                        weight: 2,
                        color: '#c5e1a5',
                        //dashArray: '3',
                        fillOpacity: 0.0
                    },
                    selected: {
                        weight: 2.5,
                        //color: '#e0f2f1',
                        color: '#f44336',
                        dashArray: '',
                    }
                    /*styleMarker: {
                        pane: 'cities',
                        radius: map.getZoom() * 1.5,
                        stroke: true,
                        weight: 1,
                        opacity: 1,
                        color: '#000000',
                        fillColor: '#e0f2f1',
                        fillOpacity: 0.3
                    },
                    styleMarkerSelected: {
                        fillColor: "#FCFF4B",
                        fillOpacity: 0.9
                    }*/
                },
                clickThrough: true,
                properties: {
                    "ref": {
                        nameSingular: "Ref"
                    }
                }
            },
            airports: {
                name: "Airports",
                nameSingular: "Airport",
                zIndex: 1016,
                style: {
                    normal: {
                        weight: 2,
                        color: '#c5e1a5',
                        //dashArray: '3',
                        fillOpacity: 0.7
                    },
                    selected: {
                        weight: 2.5,
                        //color: '#e0f2f1',
                        color: '#f44336',
                        dashArray: '',
                    }
                },
                clickThrough: true,
                properties: {
                    "name": {
                        nameSingular: "Name"
                    }
                }
            },
            cities: {
                name: "Cities",
                nameSingular: "City",
                zIndex: 1017,
                style: {
                    normal: {
                        weight: 2,
                        color: '#c5e1a5',
                        //dashArray: '3',
                        fillOpacity: 0.7
                    },
                    selected: {
                        weight: 2.5,
                        //color: '#e0f2f1',
                        color: '#f44336',
                        dashArray: '',
                    }
                },
                clickThrough: true,
                filter: {
                    name: "Min. Population",
                    filterFunction: function(feature, filterValue) {
                        if (filterValue == "") {
                            filterValue = 0;
                        }
                        return feature.properties.population != undefined && parseInt(feature.properties.population) >= parseInt(filterValue);
                    }
                },
                properties: {
                    "name": {
                        nameSingular: "Name"
                    },
                    "population": {
                        nameSingular: "Population",
                        quizCheckAnswer: function(feature, answer) {
                            //return feature.properties.ref == answer;
                            return Math.abs(answer.replace(/,/g, '') - feature.properties.population) <= 50000;
                        },
                        showAnswerOnCorrect: true
                    }
                }
            },
            'admin-levels-4': {
                name: "Admin Levels 4",
                nameSingular: "Admin Level 4",
                zIndex: 1014,
                selectedZIndex: 3013,
                style: {
                    normal: {
                        weight: 2,
                        color: '#F9A825', //900
                        //dashArray: '3',
                        fillOpacity: 0.0
                    },
                    selected: {
                        weight: 2.5,
                        //color: '#e0f2f1',
                        color: '#FFF59D', //200
                        dashArray: '',
                    }
                },
                clickThrough: true,
                properties: {
                    "name": {
                        nameSingular: "Name"
                    }
                }
            },
            'admin-levels-5': {
                name: "Admin Levels 5",
                nameSingular: "Admin Level 5",
                zIndex: 1013,
                selectedZIndex: 3014,
                style: {
                    normal: {
                        weight: 2,
                        color: '#1A237E',
                        //dashArray: '3',
                        fillOpacity: 0.0
                    },
                    selected: {
                        weight: 2.5,
                        //color: '#e0f2f1',
                        color: '#9FA8DA',
                        dashArray: '',
                    }
                },
                clickThrough: true,
                properties: {
                    "name": {
                        nameSingular: "Name"
                    }
                }
            }
        };

        var featureCollectionsFeatureGroups = {};
        var featureCollectionsSelectedLayers = {};
        var featureCollectionsCurrentFeatures = {};
        var quizQuestionTypesFeatureCollections = {};

        for (featureCollection in featureCollections) {
            addFeatureCollection(featureCollection);
        }

        function addFeatureCollection(featureCollectionName) {
            var featureCollection = featureCollections[featureCollectionName];

            // featureCollectionsFeatureGroups
            var featureCollectionPane = map.createPane(featureCollectionName);
            featureCollectionPane.style.zIndex = featureCollection.zIndex;
            /*for (styleType in featureCollection.style) {
                featureCollection.style[styleType].pane = featureCollectionName;
            }*/
            if (featureCollection.clickThrough) {
                enableForwardingOnPane(featureCollectionPane);
            }
            var featureCollectionFeatureGroup = L.featureGroup([], {
                pane: featureCollectionName
            }).addTo(map);
            featureCollectionsFeatureGroups[featureCollectionName] = featureCollectionFeatureGroup;
            featureCollectionsCurrentFeatures[featureCollectionName] = undefined;

            // featureCollectionsSelectedLayers
            var featureCollectionSelectedLayerPane = map.createPane("selected-" + featureCollectionName);
            featureCollectionSelectedLayerPane.style.zIndex = featureCollection.selectedZIndex;
            if (featureCollection.clickThrough) {
                enableForwardingOnPane(featureCollectionSelectedLayerPane);
            }
            featureCollectionsSelectedLayers[featureCollectionName] = undefined;

            createFeatureCollectionCheckboxes(featureCollectionName);
            createFeatureCollectionQuizCheckboxes(featureCollectionName);
        }

        function createFeatureCollectionCheckboxes(featureCollectionName) {
            var featureCollection = featureCollections[featureCollectionName];

            var controlsInfoTypes = document.getElementById('controls-info-types');
            var checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.name = "controls-info-feature-collection";
            checkbox.value = featureCollectionName;
            checkbox.id = "controls-info-" + featureCollectionName;

            var label = document.createElement('label');
            label.appendChild(checkbox);

            label.appendChild(document.createTextNode(" " + featureCollection.name));

            var filter = featureCollections[featureCollectionName].filter;

            if (filter != undefined) {
                var br = document.createElement('br');
                label.appendChild(br);
                var filterLabel = document.createElement('label');
                filterLabel.className = "controls-info-feature-collection-filter-label";
                filterLabel.appendChild(document.createTextNode(filter.name + ": "));
                var filterInput = document.createElement('input');
                filterInput.id = "controls-info-feature-collection-" + featureCollectionName + "-filter-input";
                filterInput.type = "text";
                filterLabel.appendChild(filterInput);
                label.appendChild(filterLabel);

                checkbox.onclick = function() {
                    if (checkbox.checked) {
                        filterInput.disabled = true;
                    } else {
                        filterInput.disabled = false;
                    }
                    toggleFeatureCollection(checkbox, featureCollectionName);
                };
            } else {
                checkbox.onclick = function() {
                    toggleFeatureCollection(checkbox, featureCollectionName);
                };
            }

            controlsInfoTypes.appendChild(label);
        }

        function createFeatureCollectionQuizCheckboxes(featureCollectionName) {
            var featureCollection = featureCollections[featureCollectionName];

            quizQuestionTypesFeatureCollections[featureCollectionName] = {};

            var quizSetupQuestionTypes = document.getElementById('quiz-setup-question-types');

            if (Object.entries(featureCollection.properties).length > 0) {
                var featureCollectionHeader = document.createElement("h5");
                featureCollectionHeader.appendChild(document.createTextNode(featureCollection.name));

                quizSetupQuestionTypes.appendChild(featureCollectionHeader);
            }

            var filter = featureCollections[featureCollectionName].filter;

            if (filter != undefined) {
                //var br = document.createElement('br');
                //quizSetupQuestionTypes.appendChild(br);
                var filterLabel = document.createElement('label');
                filterLabel.className = "quiz-setup-question-type-feature-collection-filter-label";
                filterLabel.appendChild(document.createTextNode(filter.name + ": "));
                var filterInput = document.createElement('input');
                filterInput.id = "quiz-setup-question-type-feature-collection-" + featureCollectionName + "-filter-input";
                filterInput.type = "text";
                filterLabel.appendChild(filterInput);
                quizSetupQuestionTypes.appendChild(filterLabel);
            }

            for (const [propertyKey, propertyValue] of Object.entries(featureCollection.properties)) {
                quizQuestionTypesFeatureCollections[featureCollectionName][propertyKey] = false;
                var checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                //checkbox.name = "quiz-setup-question-type";
                //checkbox.value = featureCollectionName + "," + property;
                checkbox.id = "quiz-setup-question-type-" + featureCollectionName + "-property-" + propertyKey;
                checkbox.onclick = (function(checkbox) {
                    return function() {
                        //var checkbox = document.getElementById("quiz-setup-question-type-" + featureCollectionName + "-property-" + propertyKey);
                        if (checkbox.checked) {
                            quizQuestionTypesFeatureCollections[featureCollectionName][propertyKey] = true;
                        } else {
                            quizQuestionTypesFeatureCollections[featureCollectionName][propertyKey] = false;
                        }
                    }
                })(checkbox);

                var label = document.createElement('label');
                //label.htmlFor = "checkbox-info-world-bank-" + featureCollection.name;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" " + featureCollection.name + " " + propertyValue.nameSingular));

                quizSetupQuestionTypes.appendChild(label);
            }
        }

        map.createPane('countries');
        map.getPane('countries').style.zIndex = 1001;

        function enableForwardingOnPane(pane) {
            L.DomEvent.on(pane, 'click', function(e) {
                if (e._stopped) {
                    return;
                }

                var target = e.target;
                var stopped;
                var removed;
                var ev = new MouseEvent(e.type, e)

                removed = {
                    node: target,
                    display: target.style.display
                };
                target.style.display = 'none';
                target = document.elementFromPoint(e.clientX, e.clientY);

                if (target && target !== pane) {
                    stopped = !target.dispatchEvent(ev);
                    if (stopped || ev._stopped) {
                        L.DomEvent.stop(e);
                    }
                }

                removed.node.style.display = removed.display;
            });
        }

        var layerGroupCountries = L.featureGroup([], {
            pane: map.getPane('countries')
        }).addTo(map);

        var availableIndicators = [];
        var loadedIndicators = [];
        var currentIndicators = [];

        showCountries();

        var menuOpen = false;

        var menu = document.getElementById('menu');
        if (screen.width < 700) {
            menu.style.maxWidth = "100%";
            document.getElementById("menu-content").style.maxWidth = screen.width - 60 + "px";
        } else {
            menu.style.maxWidth = 450 + "px";
            document.getElementById("menu-content").style.maxWidth = 450 - 80 + "px";
        }

        function toggleMenu() {
            var menu = document.getElementById('menu');
            if (menuOpen) {
                //menu.style.display = "none";
                menu.style.width = 0 + "px";
                //menu.style.marginLeft = -500 + "px";
                menuOpen = false;
            } else {
                menu.style.width = menu.style.maxWidth;
                //menu.style.marginLeft = 0;
                menuOpen = true;
            }
        }

        var coll = document.getElementsByClassName("collapsible-button");

        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                //this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }

        // Details

        var layerGroupCountriesSelected = L.featureGroup([]);

        var currentCountry;

        function updateDetails() {
            if (quizMode == true) {
                return;
            }
            if (currentCountry == undefined) {
                toggleDetails(false);
            } else {
                toggleDetails(true);
                var detailsCountry = document.getElementById('details-country');
                detailsCountry.innerHTML = currentCountry != undefined ? currentCountry.feature.properties.NAME_EN + " (" + numberWithCommas(currentCountry.feature.properties.POP_EST) + ")" : 'none';
                if (document.getElementById('checkbox-' + currentCountry.feature.properties.NAME_EN).checked) {
                    document.getElementById('details-country-add-remove').innerHTML = 'Remove';
                } else {
                    document.getElementById('details-country-add-remove').innerHTML = 'Add';
                }

                // Feature Collections
                var detailsFeatureCollections = document.getElementById('details-feature-collections');
                detailsFeatureCollections.innerHTML = '';

                for (const [featureCollectionKey, featureCollectionCurrentFeature] of Object.entries(featureCollectionsCurrentFeatures)) {

                    if (featureCollectionCurrentFeature != undefined) {
                        var heading = document.createElement('h4');
                        heading.innerHTML = featureCollections[featureCollectionKey].nameSingular;
                        detailsFeatureCollections.appendChild(heading);

                        for (const [propertyKey, propertyValue] of Object.entries(featureCollections[featureCollectionKey].properties)) {
                            var info = document.createElement('p');
                            info.innerHTML = propertyValue.nameSingular + ": " + featureCollectionCurrentFeature.feature.properties[propertyKey];
                            detailsFeatureCollections.appendChild(info);
                        }
                    }
                }

                // Indicators
                var detailsCountryIndicators = document.getElementById('details-country-indicators');
                detailsCountryIndicators.innerHTML = '';

                var countryIndicators = currentCountry.feature.properties.indicators;
                if (countryIndicators != undefined) {
                    for (const countryIndicator of Object.values(countryIndicators)) {
                        var heading = document.createElement('h4');
                        var info = document.createElement('p');
                        heading.innerHTML = countryIndicator.indicator.value;
                        info.innerHTML = countryIndicator.value + " [in " + countryIndicator.date + "]";
                        detailsCountryIndicators.appendChild(heading);
                        detailsCountryIndicators.appendChild(info);
                    }
                }
            }
        }

        function toggleDetails(show) {
            var details = document.getElementById('details');
            if (show) {
                details.style.height = "250px";
            } else {
                details.style.height = null;
            }
        }

        function clickAddRemoveCountryButton() {
            if (document.getElementById('checkbox-' + currentCountry.feature.properties.NAME_EN).checked) {
                removeCountryFromCurrentCountries(currentCountry);
            } else {
                addCountryToCurrentCountries(currentCountry);
            }
            updateDetails();
        }

        // Countries

        function showCountries() {
            layerGroupCountries.eachLayer(function(layer) {
                layerGroupCountries.removeLayer(layer);
            });

            createCountryCheckboxes();

            var layerCountries = L.geoJSON(countries[0].features, {
                pane: 'countries',
                style: function(feature) {
                    styleObject = getCountryStyle();
                    styleObject.fillOpacity = 0.0;
                    return styleObject;
                },
                onEachFeature: onEachCountry
            });
            layerGroupCountries.addLayer(layerCountries);
        }

        function updateCountryStyle(layerCountry) {
            if (layerCountry != undefined) {
                layerCountry.setStyle(getCountryStyle(layerCountry));
            }
        }

        function getCountryStyle(layerCountry = undefined) {
            styleObject = {
                weight: 2.5,
                opacity: 1,
                color: '#003839'
            };
            if (layerCountry != undefined) {
                styleObject = applyCountrySelectionStyle(layerCountry, styleObject);
                styleObject = applyCountryCurrentIndicatorStyle(layerCountry, styleObject);
            }
            return styleObject;
        }

        function applyCountrySelectionStyle(layerCountry, styleObject) {
            if (currentCountry == layerCountry) {
                styleObject.weight = 3;
                styleObject.color = '#81d4fa';
                styleObject.dashArray = '';
                layerCountry.bringToFront();
            } else if (layerGroupCountriesSelected.hasLayer(layerCountry)) {
                styleObject.weight = 1;
                styleObject.color = '#66bb6a';
            } else {
                layerCountry.bringToBack();
            }
            return styleObject;
        }

        function applyCountryCurrentIndicatorStyle(layerCountry, styleObject) {
            if (layerCountry.feature.properties.indicators == undefined) {
                return styleObject;
            }
            var indicatorId = document.getElementById('controls-info-country-indicator-on-map').value;
            var indicator = layerCountry.feature.properties.indicators[indicatorId];
            if (indicator != undefined && layerGroupCountriesSelected.hasLayer(layerCountry)) {
                var min = availableIndicators[indicatorId].min;
                var max = availableIndicators[indicatorId].max;

                styleObject.fillOpacity = 1.0;
                styleObject.fillColor = getGreenToRed((indicator.value - min) / (max - min) * 100);
            } else {
                styleObject.fillOpacity = 0.0;
            }
            return styleObject;
        }

        colorsToggled = false;

        function getGreenToRed(percent) {
            r = percent < 50 ? 255 : Math.floor(255 - (percent * 2 - 100) * 255 / 100);
            g = percent > 50 ? 255 : Math.floor((percent * 2) * 255 / 100);
            if (colorsToggled) {
                var tempColor = r;
                r = g;
                g = tempColor;
            }
            return 'rgb(' + r + ',' + g + ',0)';
        }

        function toggleIndicatorColors() {
            colorsToggled = !colorsToggled;
            layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                updateCountryStyle(layerCountrySelected);
            });
        }

        function onEachCountry(feature, layer) {
            /*layer.on({
            	//mouseover: highlightFeatureCountries,
            	//mouseout: resetHighlightCountries,
            	click: selectCountry
            });*/
            layer.on('click', function(event) {
                if (!quizMode) {
                    selectCountry(event.target);
                }
            });
        }

        function addCountryToCurrentCountries(layerCountry) {
            if (!layerGroupCountriesSelected.hasLayer(layerCountry)) {
                layerGroupCountriesSelected.addLayer(layerCountry);
                document.getElementById('checkbox-' + layerCountry.feature.properties.NAME_EN).checked = true;

                var checkedStatesCheckBoxes = document.querySelectorAll('input[name=controls-info-states]:checked');
                for (var i = 0; i < checkedStatesCheckBoxes.length; i++) {
                    showStatesOfCountry(layerCountry, checkedStatesCheckBoxes[i].value);
                }

                if (document.getElementById('controls-info-cities').checked) {
                    showCitiesOfCountry(layerCountry);
                }

                var checkedFeatureCollectionCheckBoxes = document.querySelectorAll('input[name=controls-info-feature-collection]:checked');
                checkedFeatureCollectionCheckBoxes.forEach(checkedFeatureCollectionCheckBox => {
                    showFeatureCollectionOfCountry(checkedFeatureCollectionCheckBox.value, layerCountry);
                });

                updateCountryStyle(layerCountry);
            }
        }

        function removeCountryFromCurrentCountries(layerCountry) {
            layerGroupCountriesSelected.removeLayer(layerCountry);
            document.getElementById('checkbox-' + layerCountry.feature.properties.NAME_EN).checked = false;

            var checkedStatesCheckBoxes = document.querySelectorAll('input[name=controls-info-states]:checked');
            for (var i = 0; i < checkedStatesCheckBoxes.length; i++) {
                removeStatesOfCountry(layerCountry, checkedStatesCheckBoxes[i].value);
            }

            if (document.getElementById('controls-info-cities').checked) {
                removeCitiesOfCountry(layerCountry);
            }

            var checkedFeatureCollectionCheckBoxes = document.querySelectorAll('input[name=controls-info-feature-collection]:checked');
            checkedFeatureCollectionCheckBoxes.forEach(checkedFeatureCollectionCheckBox => {
                removeFeatureCollectionOfCountry(checkedFeatureCollectionCheckBox.value, layerCountry);
            });

            updateCountryStyle(currentCountry);
        }

        function selectCountry(country) {
            if (currentCountry != undefined && country != currentCountry) {
                unselectCountry(currentCountry);
            }

            currentCountry = country;
            updateCountryStyle(country);
            updateDetails();
        }

        function unselectCountry(country) {
            for (const [featureCollectionKey, featureCollectionCurrentFeature] of Object.entries(featureCollectionsCurrentFeatures)) {
                unselectFeature(featureCollectionCurrentFeature);
            }

            currentCountry = undefined;
            updateCountryStyle(country);
            updateDetails();
        }

        function selectCountries(filter) {
            layerGroupCountries.eachLayer(function(layerCountries) {
                layerCountries.eachLayer(function(layerCountry) {
                    if (filter(layerCountry)) {
                        addCountryToCurrentCountries(layerCountry);
                    }
                });
            });
        }

        function unselectCountries(filter) {
            layerGroupCountriesSelected.eachLayer(function(layerCountry) {
                if (filter(layerCountry)) {
                    removeCountryFromCurrentCountries(layerCountry);
                }
            });
        }

        function zoomToBiggestSelectedArea() {
            if (layerGroupStates.getBounds().isValid()) {
                map.fitBounds(layerGroupStates.getBounds());
            } else {
                map.fitBounds(layerGroupCountries.getBounds());
            }
        }

        function zoomToCountry(layerCountry, padding = 0.2) {
            var bounds = layerCountry.getBounds().pad(padding);
            //bounds._northEast.lat = bounds._northEast.lat-5;
            //bounds._southWest.lat = bounds._southWest.lat-5;
            map.flyToBounds(bounds);
        }

        function createCountryCheckboxes() {
            var quizSetupCountries = document.getElementById("controls-countries");

            for (i = 0; i < countries[0].features.length; i++) {
                var feature = countries[0].features[i];

                var checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.name = "controls-setup-country";
                checkbox.value = feature.properties.NAME_EN;
                checkbox.id = "checkbox-" + feature.properties.NAME_EN;
                checkbox.onclick = toggleCountryCheckbox;

                var label = document.createElement('label');
                label.htmlFor = "checkbox-" + feature.properties.NAME_EN;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(feature.properties.NAME_EN));

                quizSetupCountries.appendChild(label);
            }
        }

        function toggleCountryCheckbox(event) {
            var countryName = event.target.value;
            layerGroupCountries.eachLayer(function(layerCountries) {
                layerCountries.eachLayer(function(layerCountry) {
                    if (layerCountry.feature.properties.NAME_EN == countryName) {
                        if (event.target.checked) {
                            addCountryToCurrentCountries(layerCountry);
                        } else {
                            removeCountryFromCurrentCountries(layerCountry);
                        }
                    }
                });
            });
        }

        // Feature Collections

        async function showFeatureCollectionOfCountry(featureCollectionName, country) {
            var alreadyShown = false;
            featureCollectionsFeatureGroups[featureCollectionName].eachLayer(function(layerFeatureCollectionOfCountry) {
                if (layerFeatureCollectionOfCountry.country == country) {
                    alreadyShown = true;
                }
            });
            if (alreadyShown) {
                return;
            }

            const json = await fetch('data/' + featureCollectionName + '/' + country.feature.properties.ISO_A3 + '.json').then(response => response.json());
            var layerFeatureCollectionOfCountry = L.geoJSON(json, {
                pane: featureCollectionName,
                style: function() {
                    return featureCollections[featureCollectionName].style.normal;
                    //return getFeatureStyle();
                },
                pointToLayer: function(feature, latlng) {
                    var styleObject = Object.assign({}, featureCollections[featureCollectionName].style.normal);
                    styleObject.pane = featureCollectionName;
                    return L.circleMarker(latlng, styleObject);
                    //return L.circleMarker(latlng, featureCollections[featureCollectionName].style);
                },
                filter: function(feature) {
                    var filter = featureCollections[featureCollectionName].filter;
                    if (filter != undefined) {
                        if (quizMode) {
                            return filter.filterFunction(feature, document.getElementById("quiz-setup-question-type-feature-collection-" + featureCollectionName + "-filter-input").value);
                        } else {
                            return filter.filterFunction(feature, document.getElementById("controls-info-feature-collection-" + featureCollectionName + "-filter-input").value);
                        }
                    }
                    return true;
                    //return f.properties.geonunit === country.feature.properties.NAME_EN;
                },
                onEachFeature: function(feature, layer) {
                    layer.feature.properties.layerCountry = country;
                    layer['featureCollectionName'] = featureCollectionName;
                    layer.on('click', function(event) {
                        if (!quizMode) {
                            selectCountry(event.target.feature.properties.layerCountry)
                            selectFeature(event.target);
                        }
                    });
                }
            });
            layerFeatureCollectionOfCountry.country = country;
            featureCollectionsFeatureGroups[featureCollectionName].addLayer(layerFeatureCollectionOfCountry);
        }

        function updateFeatureStyle(layerFeature) {
            if (layerFeature != undefined) {
                layerFeature.setStyle(getFeatureStyle(layerFeature));
            }
        }

        function getFeatureStyle(layerFeature) {
            var result;
            if (layerFeature != undefined && layerFeature == featureCollectionsCurrentFeatures[layerFeature.featureCollectionName]) {
                /*if (layerFeature.geometry.type == "Polygon") {

                } else {

                }*/
                return featureCollections[layerFeature.featureCollectionName].style.selected;
            }
            return featureCollections[layerFeature.featureCollectionName].style.normal;
        }

        /*function applyFeatureSelectedStyle(layerFeature, styleObject) {
            if (layerFeature == currentFeature) {
                styleObject.weight = 2.5;
                //color: '#e0f2f1',
                styleObject.color = '#f44336';
                styleObject.dashArray = '';
            }
            return styleObject;
        }*/

        /*function getFeatureMarkerStyle(layerFeature = undefined) {
            styleObject = {
                //pane: 'airports',
                radius: map.getZoom() * 1.5,
                stroke: true,
                weight: 1,
                opacity: 1,
                color: '#000000',
                fillColor: '#e0f2f1',
                fillOpacity: 0.3
            };
            if (layerFeature != undefined) {
                styleObject = applyMarkerSelectionStyle(layerFeature, styleObject);
            }
            return styleObject;
        }*/

        /*function applyMarkerSelectionStyle(layerFeature, styleObject) {
            if (layerFeature == currentCity) {
                styleObject.fillColor = "#FCFF4B";
                styleObject.fillOpacity = 0.9;
            }
            return styleObject;
        }*/

        function removeFeatureCollectionOfCountry(featureCollectionName, layerCountry) {
            featureCollectionsFeatureGroups[featureCollectionName].eachLayer(function(layerFeatureCollectionOfCountry) {
                if (layerFeatureCollectionOfCountry.country === layerCountry) {
                    var currentFeatureCollectionFeature = featureCollectionsCurrentFeatures[featureCollectionName];
                    if (currentFeatureCollectionFeature != undefined && currentFeatureCollectionFeature.feature.properties.layerCountry == layerCountry) {
                        unselectFeature(currentFeatureCollectionFeature);
                    }
                    featureCollectionsFeatureGroups[featureCollectionName].removeLayer(layerFeatureCollectionOfCountry);
                }
            });
        }

        function selectFeature(layerFeature) {
            if (layerFeature == undefined) {
                return;
            }

            unselectFeature(featureCollectionsCurrentFeatures[layerFeature.featureCollectionName]);

            featureCollectionsCurrentFeatures[layerFeature.featureCollectionName] = layerFeature;

            featureCollectionsSelectedLayer = L.geoJSON(layerFeature.toGeoJSON(), {
                pane: 'selected-' + layerFeature.featureCollectionName,
                style: function() {
                    return featureCollections[layerFeature.featureCollectionName].style.selected;
                },
                pointToLayer: function(feature, latlng) {
                    var styleObject = Object.assign({}, featureCollections[layerFeature.featureCollectionName].style.selected);
                    styleObject.pane = layerFeature.featureCollectionName;
                    return L.circleMarker(latlng, styleObject);
                    //return L.circleMarker(latlng, featureCollections[featureCollectionName].style);
                }
            });
            featureCollectionsSelectedLayer.addTo(map);
            featureCollectionsSelectedLayers[layerFeature.featureCollectionName] = featureCollectionsSelectedLayer;

            updateFeatureStyle(layerFeature);

            layerFeature.bringToFront();

            updateDetails();
        }

        function unselectFeature(layerFeature) {
            /*if (currentCity != undefined && layerFeature != undefined && currentCity.feature.properties.ADM1NAME == layerFeature.feature.properties.name) {
                unselectCity(currentCity);
            }*/

            if (layerFeature != undefined) {
                featureCollectionsCurrentFeatures[layerFeature.featureCollectionName] = undefined;
                map.removeLayer(featureCollectionsSelectedLayers[layerFeature.featureCollectionName]);
                featureCollectionsSelectedLayers[layerFeature.featureCollectionName] = undefined;
                updateFeatureStyle(layerFeature);
                updateDetails();
            }
        }

        function zoomToFeature(layerFeature) {
            map.fitBounds(layerFeature.getBounds().pad(0.5));
        }

        function toggleFeatureCollection(checkbox, featureCollectionName) {
            if (checkbox.checked) {
                layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                    showFeatureCollectionOfCountry(featureCollectionName, layerCountrySelected);
                });
            } else {
                layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                    removeFeatureCollectionOfCountry(featureCollectionName, layerCountrySelected);
                });
            }
        }

        // Indicators

        // World Bank Indicatiors

        loadIndicators();

        function loadIndicators() {
            fetch('https://api.worldbank.org/v2/indicators?per_page=2000&source=2&format=json')
                .then(response => response.json())
                .then(data => {
                    var indicators = data[1];
                    for (var i = 0; i < indicators.length; i++) {
                        var indicator = indicators[i];
                        indicator.countryDataLoaded = false;
                        indicator.active = false;
                        availableIndicators[indicator.id] = indicator;
                    }

                    createInfoIndicatorCheckboxes();
                    createQuizIndicatorCheckboxes();
                });
        }

        function createInfoIndicatorCheckboxes() {
            var controlsInfoCountryIndicators = document.getElementById('controls-info-country-indicators');
            for (const availableIndicator of Object.values(availableIndicators)) {
                var checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.name = "controls-info-country-indicator";
                checkbox.value = availableIndicator.id;
                checkbox.id = "checkbox-info-world-bank-" + availableIndicator.id;
                checkbox.onclick = function() {
                    toggleCheckboxInfoCountryIndicator(event);
                };

                var label = document.createElement('label');
                label.htmlFor = "checkbox-info-world-bank-" + availableIndicator.id;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" " + availableIndicator.name));

                controlsInfoCountryIndicators.appendChild(label);
            }
        }

        function createQuizIndicatorCheckboxes() {
            var controlsInfoCountryIndicators = document.getElementById('quiz-setup-country-indicators');
            for (const availableIndicator of Object.values(availableIndicators)) {
                var checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.name = "quiz-setup-country-indicator";
                checkbox.value = availableIndicator.id;
                checkbox.id = "checkbox-quiz-setup-country-indicator-" + availableIndicator.id;
                checkbox.onclick = function() {
                    toggleCheckboxQuestionSetupCountryIndicator(event);
                };

                var label = document.createElement('label');
                label.htmlFor = "checkbox-quiz-setup-country-indicator-" + availableIndicator.id;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" " + availableIndicator.name));

                controlsInfoCountryIndicators.appendChild(label);
            }
        }

        function toggleCheckboxInfoCountryIndicator(event) {
            if (event.target.checked) {
                checkIndicator(event.target.value);
            } else {
                uncheckIndicator(event.target.value);
            }
        }

        function checkIndicator(indicatorId) {
            if (availableIndicators[indicatorId].countryDataLoaded) {
                if (!availableIndicators[indicatorId].active) {
                    activateIndicator(indicatorId);
                }
            } else {
                loadCountryIndicatorData(indicatorId, function() {
                    activateIndicator(indicatorId);
                    updateDetails();
                });
            }
        }

        function activateIndicator(indicatorId) {
            var indicator = availableIndicators[indicatorId];
            var countryIndicatorOnMapSelect = document.getElementById('controls-info-country-indicator-on-map');
            var indicatorOption = document.createElement("option");
            indicatorOption.text = indicator.name;
            indicatorOption.value = indicator.id;
            countryIndicatorOnMapSelect.add(indicatorOption);

            indicator.active = true;
        }

        function loadCountryIndicatorData(indicatorId, onSuccess = function() {}) {
            /*fetch('https://api.worldbank.org/v2/countries/all/indicator/' + indicatorId + '?mrnev=1&per_page=400&format=json&date=2012:2020', {

                    headers: headers
                })
                .then(response => response.json())
                .then(data => {
                    var min = undefined;
                    var max = undefined;
                    var dataMappedToCountryKeys = [];

                    layerGroupCountries.eachLayer(function(layerCountries) {
                        layerCountries.eachLayer(function(layerCountry) {
                            data[1].forEach(d => {
                                if (d.countryiso3code == layerCountry.feature.properties.ISO_A3) {
                                    if (min == undefined || d.value < min) {
                                        min = d.value;
                                    }
                                    if (max == undefined || d.value > max) {
                                        max = d.value;
                                    }
                                    //dataMappedToCountryKeys[layerCountry] = d;
                                    if (layerCountry.feature.properties.indicators == undefined) {
                                        layerCountry.feature.properties.indicators = [];
                                    }
                                    var presentIndicators = layerCountry.feature.properties.indicators;

                                    presentIndicators[indicatorId] = d;
                                }
                            });
                        });
                    });
                    availableIndicators[indicatorId].min = min;
                    availableIndicators[indicatorId].max = max;
                    availableIndicators[indicatorId].countryDataLoaded = true;
                })
                .then(onSuccess());*/

            var xhttp = new XMLHttpRequest();
            xhttp.responseType = 'json';
            console.log(xhttp.responseURL)
            xhttp.onreadystatechange = function() {
                //var data = JSON.parse(this.responseText);
                //console.log(this.responseText);

                var data = xhttp.response;
                console.log(data);

                if (this.readyState == 4 && this.status == 200) {
                    var min = undefined;
                    var max = undefined;
                    var dataMappedToCountryKeys = [];

                    layerGroupCountries.eachLayer(function(layerCountries) {
                        layerCountries.eachLayer(function(layerCountry) {
                            data[1].forEach(d => {
                                if (d.countryiso3code == layerCountry.feature.properties.ISO_A3) {
                                    var presentIndicators = layerCountry.feature.properties.indicators;
                                    if (d.value == null || (presentIndicators != undefined && presentIndicators[indicatorId] != undefined && presentIndicators[indicatorId].date > d.date)) {
                                        return
                                    } else {
                                        if (min == undefined || d.value < min) {
                                            min = d.value;
                                        }
                                        if (max == undefined || d.value > max) {
                                            max = d.value;
                                        }
                                        //dataMappedToCountryKeys[layerCountry] = d;
                                        if (layerCountry.feature.properties.indicators == undefined) {
                                            layerCountry.feature.properties.indicators = [];
                                        }
                                        var presentIndicators = layerCountry.feature.properties.indicators;

                                        presentIndicators[indicatorId] = d;
                                    }
                                }
                            });
                        });
                    });
                    availableIndicators[indicatorId].min = min;
                    availableIndicators[indicatorId].max = max;
                    availableIndicators[indicatorId].countryDataLoaded = true;

                    onSuccess();
                }
            };
            xhttp.open("GET", "https://api.worldbank.org/v2/countries/all/indicator/" + indicatorId + "?per_page=5000&format=json&date=2014:2020", true);
            xhttp.send();
        }

        function uncheckIndicator(indicatorId) {
            deactivateIndicator(indicatorId);
            updateDetails();
        }

        function deactivateIndicator(indicatorId) {
            var countryIndicatorOnMapSelect = document.getElementById('controls-info-country-indicator-on-map');
            var selectedIndex = countryIndicatorOnMapSelect.selectedIndex;
            for (var i = 0; i < countryIndicatorOnMapSelect.length; i++) {
                if (countryIndicatorOnMapSelect.options[i].value == indicatorId) {
                    countryIndicatorOnMapSelect.remove(i);
                    if (i == selectedIndex) {
                        indicatorOnMapChanged();
                    }
                }
            }
            availableIndicators[indicatorId].active = false;
        }

        function indicatorOnMapChanged() {
            layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                updateCountryStyle(layerCountrySelected);
            });
            updateDetails();
        }

        function toggleCheckboxQuestionSetupCountryIndicator(event) {
            if (event.target.checked) {
                var indicatorId = event.target.value;
                if (!availableIndicators[indicatorId].countryDataLoaded) {
                    loadCountryIndicatorData(indicatorId);
                }
            }
        }

        // Quiz

        var quizMode = false;
        var quizQuestionTypes;
        var quizCountryIndicators;
        var tasks;
        var currentTask;

        function startQuiz() {
            if (layerGroupCountriesSelected.getLayers().length == 0) {
                alert("Please select a country");
                return;
            }
            quizMode = true;

            var checkedQuestionTypeCheckBoxes = document.querySelectorAll('input[name=quiz-setup-question-type]:checked');
            quizQuestionTypes = [];
            for (var i = 0; i < checkedQuestionTypeCheckBoxes.length; i++) {
                quizQuestionTypes.push(checkedQuestionTypeCheckBoxes[i].value);
            }

            var checkedCountryIndicatorCheckBoxes = document.querySelectorAll('input[name=quiz-setup-country-indicator]:checked');
            quizCountryIndicators = [];
            for (var i = 0; i < checkedCountryIndicatorCheckBoxes.length; i++) {
                quizCountryIndicators.push(checkedCountryIndicatorCheckBoxes[i].value);
            }

            setUpQuizVisuals(() => {
                document.getElementById('menu-button-open').style.display = "none";
                toggleMenu();
                toggleDetails(false);
                document.getElementById('quiz-panel').style.display = "block";

                savedBounds = undefined;

                currentIndex = 0;
                generateQuestions();
                nextQuestion();
            });
        }

        class Dispatcher {
            constructor(pCount, pCallback) {
                this.count = pCount;
                this.callback = pCallback;
            }

            increase() {
                this.count++;
            }

            decrease() {
                this.count--;
                if (this.count <= 0) {
                    this.callback();
                }
            }
        }

        async function setUpQuizVisuals(callback) {
            unselectCountry(currentCountry);

            var dispatcher = new Dispatcher(1, callback);

            await layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                for (const [featureCollectionKey, featureCollectionValue] of Object.entries(quizQuestionTypesFeatureCollections)) {
                    var load = false;
                    for (const [propertyKey, propertyValue] of Object.entries(featureCollectionValue)) {
                        if (propertyValue) {
                            load = true;
                            break;
                        }
                    }
                    if (load) {
                        dispatcher.increase();
                        removeFeatureCollectionOfCountry(featureCollectionKey, layerCountrySelected);
                        showFeatureCollectionOfCountry(featureCollectionKey, layerCountrySelected).then(() => {
                            dispatcher.decrease();
                        });
                    } else {
                        removeFeatureCollectionOfCountry(featureCollectionKey, layerCountrySelected);
                    }
                }
            });

            dispatcher.decrease();
        }

        async function tearDownQuizVisuals() {
            layerGroupCountriesSelected.eachLayer(await async function(layerCountrySelected) {
                var featureCollectionCheckBoxes = document.querySelectorAll('input[name=controls-info-feature-collection]');
                featureCollectionCheckBoxes.forEach(featureCollectionCheckBox => {
                    if (featureCollectionCheckBox.checked) {
                        removeFeatureCollectionOfCountry(featureCollectionCheckBox.value, layerCountrySelected);
                        showFeatureCollectionOfCountry(featureCollectionCheckBox.value, layerCountrySelected);
                    } else {
                        removeFeatureCollectionOfCountry(featureCollectionCheckBox.value, layerCountrySelected);
                    }
                });
            });
            for (const [featureGroupKey, featureGroupValue] of Object.entries(featureCollectionsFeatureGroups)) {
                if (!map.hasLayer(featureGroupValue)) {
                    featureGroupValue.addTo(map);
                }
            }
        }

        function generateQuestions() {
            tasks = [];

            var tasksCountries = [];
            layerGroupCountriesSelected.eachLayer(function(layerCountrySelected) {
                tasksCountry = [];

                if (quizQuestionTypes.includes("country-name")) {
                    var taskCountryName = {
                        "type": "country-name",
                        "country": layerCountrySelected
                    }
                    tasksCountry.push(taskCountryName);
                }

                if (quizQuestionTypes.includes("country-population")) {
                    var taskCountryPopulation = {
                        "type": "country-population",
                        "country": layerCountrySelected
                    }
                    tasksCountry.push(taskCountryPopulation);
                }

                if (layerCountrySelected.feature.properties.indicators != null) {
                    for (const indicator of Object.values(layerCountrySelected.feature.properties.indicators)) {
                        if (quizCountryIndicators.includes(indicator.indicator.id)) {
                            var taskCountryIndicator = {
                                "type": "country-indicator",
                                "country": layerCountrySelected,
                                "indicator": indicator
                            }
                            tasksCountry.push(taskCountryIndicator);
                        }
                    }
                }

                tasksCountries.push.apply(tasksCountries, shuffle(tasksCountry));
            });

            var tasksFeatureCollectionProperties = [];
            for (featureCollectionKey in quizQuestionTypesFeatureCollections) {
                var featureCollectionValue = quizQuestionTypesFeatureCollections[featureCollectionKey];
                for (propertyKey in featureCollectionValue) {
                    var propertyValue = featureCollectionValue[propertyKey];
                    if (propertyValue) {
                        featureCollectionsFeatureGroups[featureCollectionKey].eachLayer((featureCollectionOfCountry) => {
                            featureCollectionOfCountry.eachLayer((layerFeature) => {
                                if (layerFeature.feature.properties[propertyKey] != undefined) {
                                    var task = {
                                        "type": "feature-collection-property",
                                        "layerFeature": layerFeature,
                                        "property": propertyKey
                                    }
                                    tasksFeatureCollectionProperties.push(task);
                                }
                            });
                        });
                    }
                }
            }

            tasks.push.apply(tasks, shuffle(tasksCountries));
            tasks.push.apply(tasks, shuffle(tasksFeatureCollectionProperties));

            tasks = shuffle(tasks);
        }

        function shuffle(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        function hideFeatureCollection(featureCollectionName) {
            if (featureCollectionsFeatureGroups[featureCollectionName] != undefined) {
                map.removeLayer(featureCollectionsFeatureGroups[featureCollectionName]);
            }
            if (featureCollectionsSelectedLayers[featureCollectionName] != undefined) {
                map.removeLayer(featureCollectionsSelectedLayers[featureCollectionName]);
            }
        }

        var currentIndex = 0;
        var repeat = false;

        function nextQuestion() {
            if (currentIndex == tasks.length) {
                finishQuiz();
                return;
            }
            questionState = true;
            document.getElementById("quiz-panel-question-evaluation").style.display = "none";
            document.getElementById("quiz-panel-question-content").style.display = "block";
            document.getElementById("quiz-panel-submit-button").innerHTML = "Submit";
            document.getElementById("quiz-panel-input").value = "";
            document.getElementById("quiz-panel-input-container").style.width = "auto";
            document.getElementById("quiz-panel-input-container").style.height = "auto";
            currentTask = tasks[currentIndex];

            for (const [featureGroupKey, featureGroupValue] of Object.entries(featureCollectionsFeatureGroups)) {
                hideFeatureCollection(featureGroupKey);
            }

            switch (currentTask.type) {
                case "country-name":
                    selectCountry(currentTask.country);
                    //zoomToCountry(currentTask.country, 2);
                    map.flyTo(currentTask.country.getCenter(), 3);
                    document.getElementById("quiz-panel-question").innerHTML = "What is the name of this country?";
                    break;
                case "country-population":
                    selectCountry(currentTask.country);
                    map.flyTo(currentTask.country.getCenter(), 3);
                    document.getElementById("quiz-panel-question").innerHTML = "What is the population of this country in " + currentTask.country.feature.properties.POP_YEAR + "?";
                    break;
                case "country-indicator":
                    selectCountry(currentTask.country);
                    map.flyTo(currentTask.country.getCenter(), 3);
                    document.getElementById("quiz-panel-question").innerHTML = "What is the " + currentTask.indicator.indicator.value + " of this country in " + currentTask.indicator.date + "?";
                    break;
                case "feature-collection-property":
                    if (!map.hasLayer(featureCollectionsFeatureGroups[currentTask.layerFeature.featureCollectionName])) {
                        featureCollectionsFeatureGroups[currentTask.layerFeature.featureCollectionName].addTo(map);
                    }
                    selectCountry(currentTask.layerFeature.feature.properties.layerCountry);
                    selectFeature(currentTask.layerFeature);
                    zoomToCountry(currentTask.layerFeature.feature.properties.layerCountry);

                    /*var point = currentTask.city.getLatLng();
                    map.flyTo([point.lat - 1, point.lng], 5);*/

                    var featureCollectionDisplayNameSingular = featureCollections[currentTask.layerFeature.featureCollectionName].nameSingular;

                    document.getElementById("quiz-panel-question").innerHTML = "What is the " + currentTask.property + " of this " + featureCollectionDisplayNameSingular + "?";
                    break;
            }
        }

        function checkAnswer() {
            questionState = false;
            switch (currentTask.type) {
                case "country-name":
                    if (document.getElementById("quiz-panel-input").value == currentTask.country.feature.properties.NAME_EN) {
                        answerRight(currentTask);
                        showAnswerRightWrong(true, null);
                    } else {
                        answerWrong(currentTask);
                        showAnswerRightWrong(false, "The correct answer is: " + currentTask.country.feature.properties.NAME_EN);
                    }
                    break;
                case "country-population":
                    if (Math.abs(document.getElementById("quiz-panel-input").value.replace(/,/g, '') - currentTask.country.feature.properties.POP_EST) <= 1000000) {
                        answerRight(currentTask);
                        showAnswerRightWrong(true, "the exact answer is: " + numberWithCommas(currentTask.country.feature.properties.POP_EST));
                    } else {
                        answerWrong(currentTask);
                        showAnswerRightWrong(false, "the correct answer is: " + numberWithCommas(currentTask.country.feature.properties.POP_EST));
                    }
                    break;
                case "country-indicator":
                    if (Math.abs(document.getElementById("quiz-panel-input").value.replace(/,/g, '') - currentTask.indicator.value) <= 0.10 * currentTask.indicator.value) {
                        answerRight(currentTask);
                        showAnswerRightWrong(true, "the exact answer is: " + numberWithCommas(currentTask.indicator.value));
                    } else {
                        answerWrong(currentTask);
                        showAnswerRightWrong(false, "the correct answer is: " + numberWithCommas(currentTask.indicator.value));
                    }
                    break;
                case "feature-collection-property":
                    var property = featureCollections[currentTask.layerFeature.featureCollectionName].properties[currentTask.property];
                    var checkFunction;
                    if (property.quizCheckAnswer != undefined) {
                        checkFunction = property.quizCheckAnswer;
                    } else {
                        checkFunction = function(feature, answer) {
                            return answer == feature.properties[currentTask.property];
                        }
                    }

                    // showAnswerRightWrong(true, "the exact answer is: " + numberWithCommas(currentTask.state.feature.properties.all_tags.population));

                    if (checkFunction(currentTask.layerFeature.feature, document.getElementById("quiz-panel-input").value)) {
                        answerRight(currentTask);
                        if (property.showAnswerOnCorrect == true) {
                            showAnswerRightWrong(true, "The exact answer is: " + currentTask.layerFeature.feature.properties[currentTask.property]);
                        } else {
                            showAnswerRightWrong(true, null);
                        }
                    } else {
                        answerWrong(currentTask);
                        showAnswerRightWrong(false, "The correct answer is: " + currentTask.layerFeature.feature.properties[currentTask.property]);
                    }
                    break;
            }
        }

        function answerRight(task) {
            currentIndex++;
            if (repeat) {
                repeat = false;
                tasks.splice(currentIndex + 2, 0, task);
                tasks.splice(currentIndex + 4, 0, task);
                tasks.splice(currentIndex + 7, 0, task);
                tasks.splice(currentIndex + 13, 0, task);
            }
        }

        function answerWrong(task) {
            if (!repeat) {
                repeat = true;
            }
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function showAnswerRightWrong(right, infos) {
            document.getElementById("quiz-panel-question-content").style.display = "none";
            document.getElementById("quiz-panel-submit-button").innerHTML = "Next";
            document.getElementById("quiz-panel-question-evaluation").style.display = "block";
            document.getElementById("quiz-panel-question-evaluation-right-wrong").innerHTML = right ? "Correct" : "False";
            document.getElementById("quiz-panel-question-evaluation-infos").innerHTML = infos != null ? infos : "";
            document.getElementById("quiz-panel-input-container").style.width = "0px";
            document.getElementById("quiz-panel-input-container").style.height = "0px";
        }

        function checkResizeMap(focus) {
            if (focus) {
                document.getElementById('top-bar').style.height = "0px";
            } else {
                document.getElementById('top-bar').style.height = "50px";
            }
        }

        var questionState;

        function questionPanelSubmitButtonClicked(event) {
            event.preventDefault();
            document.getElementById("quiz-panel-input").focus();
            if (questionState) {
                checkAnswer();
            } else {
                nextQuestion();
            }
        }

        function finishQuiz() {
            unselectCountry(currentCountry);

            quizMode = false;
            tearDownQuizVisuals();

            document.getElementById('quiz-panel').style.display = "none";
            document.getElementById('menu-button-open').style.display = "block";
            toggleMenu();
        }

        /*const myEventForwarder = new L.eventForwarder({
            map: map,
            events: {
                click: true,
                mousemove: true,
                mouseout: true
            }
        });

        myEventForwarder.enable(); */

        //map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');
    </script>

</body>

</html>