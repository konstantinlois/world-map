<!DOCTYPE html>
<html>
<head>

	<title>World Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
	<script src="./leaflet-event-forwarder.js"></script>

	<script src="countries.json"></script>
	<script src="states.json"></script>
	<script src="cities.json"></script>

	<style>
			body {
					padding: 0;
					margin: 0;
			}
			html, body, #map {
					height: 100%;
					width: 100%;
					background: #9999FF;
			}

			.info {
				color: #ffffff;
			}

			#quiz {
				position:absolute;
				top:100px;
				left: 10px;
				z-index: 1000;
				background: #fff;
				padding: 20px 20px 20px 20px;
				border-radius: 5px;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
			}

			#quiz-setup {
				display: block;
			}

			#quiz-panel {
				width: 250px;
				display: none;
			}

			#details {
				position:absolute;
				width: 250px;
				top:100px;
				right: 10px;
				z-index: 1000;
				background: #fff;
				padding: 20px;
				border-radius: 5px;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
			}

			.details-heading {
				line-height: 0.1;
			}

			#quiz-setup-countries {
				border:2px solid #ccc; width:300px; height: 100px; overflow-y: scroll;
			}

			#quiz-setup-countries label {
				display: block;
			}

			#quiz-setup-question-types {
				border:2px solid #ccc; width:300px; height: 100px; overflow-y: scroll;
			}

			#quiz-setup-question-types label {
				display: block;
			}

	</style>

</head>
<body>



<div id="map" style="width: 100%; height: 100%;"></div>

<div id="quiz">

<div id="quiz-setup">
	<h2>Setup</h2>
	<h4>Countries</h4>
	<div id="quiz-setup-countries">
	</div>
	<br></br>
	<div id="quiz-setup-question-types">
    <label><input type="checkbox" name="quiz-setup-question-type" value="country-name"/> Country Name</label>
    <label><input type="checkbox" name="quiz-setup-question-type" value="country-population"/> Country Population</label>
		<label><input type="checkbox" name="quiz-setup-question-type" value="state-name"/> State Name</label>
		<label><input type="checkbox" name="quiz-setup-question-type" value="city-name"/> City Name</label>
	</div>
	<br>
	<button onclick="startQuiz()">Start</button>
</div>

<div id="quiz-panel">
	<h2>Question</h2>
	<h4 id="quiz-panel-question"></h4>
	<form onsubmit="checkAnswer(event)">
		<input id="quiz-panel-input" type="text" autocomplete="off">
		<button id="quiz-panel-submit-button" type="submit">Submit</button>
	</form>
	<button onclick="finishQuiz()">Quit</button>
</div>

</div>

<div id="details">
	<h4 class="details-heading">Country</h4>
	<p id="details-country">Test</p>
	<h4 class="details-heading">State</h4>
	<p id="details-state">Test</p>
	<h4 class="details-heading">City</h4>
	<p id="details-city">Test</p>
</div>

<script type="text/javascript">

	var map = L.map('map').setView([37.8, -96], 4);

	L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
		maxZoom: 16
	}).addTo(map);

	var layerGroupCountries = L.featureGroup([]).addTo(map);
	var layerGroupStates = L.featureGroup([]).addTo(map);
	var layerGroupCities = L.featureGroup([]).addTo(map);

	showCountries();

	// Details

	var layerGroupCountriesSelected = L.featureGroup([]);

	var currentCountry;
	var currentState;
	var currentCity;

	// Quiz
	var quizMode = false;

	function updateDetails(){
		var detailsCountry = document.getElementById('details-country');
		detailsCountry.innerHTML = currentCountry != undefined ? currentCountry.feature.properties.NAME_EN + " (" + numberWithCommas(currentCountry.feature.properties.POP_EST) + ")" : 'none';

		var detailsState = document.getElementById('details-state');
		detailsState.innerHTML = currentState != undefined ? currentState.feature.properties.name : 'none';

		var detailsCity = document.getElementById('details-city');
		detailsCity.innerHTML = currentCity != undefined ? currentCity.feature.properties.name_en + " (" + numberWithCommas(currentCity.feature.properties.POP_MIN) + ")" : 'none';
	}

	// Countries

	function showCountries(){
		layerGroupCountries.eachLayer(function(layer) { layerGroupCountries.removeLayer(layer);});

		createCountryCheckboxes();

		var layerCountries = L.geoJSON(countries[0].features, {
			style: styleCountry,
			//filter: function(f){ return f.properties.geonunit === countryLayer.feature.properties.NAME_EN },
			onEachFeature: onEachCountry
		});
		layerGroupCountries.addLayer(layerCountries);
	}

	function createCountryCheckboxes(){
		var quizSetupCountries = document.getElementById("quiz-setup-countries");

		for (i = 0; i < countries[0].features.length; i++){
			var feature = countries[0].features[i];

			var checkbox = document.createElement('input');
			checkbox.type = "checkbox";
			checkbox.name = "quiz-setup-country";
			checkbox.value = feature.properties.NAME_EN;
			checkbox.id = "checkbox-" + feature.properties.NAME_EN;
			checkbox.onclick = selectCountryCheckbox;

			var label = document.createElement('label');
			label.htmlFor = "checkbox-" + feature.properties.NAME_EN;
			label.appendChild(checkbox);
			label.appendChild(document.createTextNode(feature.properties.NAME_EN));

			quizSetupCountries.appendChild(label);
		}
	}

	function styleCountry(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: '#003839',
			//dashArray: '3',
			fillOpacity: 0.0,
			//fillColor: '#6abf69'
		};
	}

	function onEachCountry(feature, layer) {
		/*layer.on({
			//mouseover: highlightFeatureCountries,
			//mouseout: resetHighlightCountries,
			click: selectCountry
		});*/
		layer.on('click', function(event){
			if(!quizMode){
				document.getElementById('checkbox-' + event.target.feature.properties.NAME_EN).checked = true;
				selectCountry(event.target);
				showStatesOfCountry(event.target);
				showCitiesOfCountry(event.target);
			}
		});
	}

	function selectCountry(layer){
		if(currentCountry == layer){
			return;
		}else{
			unselectState(currentState);
			unselectCity(currentCity);
			currentState = undefined;
			currentCity = undefined;
		}
		if(currentCountry != undefined){
			resetHighlightCountry(currentCountry);
		}
		currentCountry = layer;
		if(!layerGroupCountriesSelected.hasLayer(layer)){
			layerGroupCountriesSelected.addLayer(layer);
		}
		highlightCountry(layer);
		updateDetails();
	}

	function zoomToBiggestSelectedArea(){
		if(layerGroupStates.getBounds().isValid()){
			map.fitBounds(layerGroupStates.getBounds());
		}else{
			map.fitBounds(layerGroupCountries.getBounds());
		}
	}

	function selectCountryCheckbox(event){
		var countryName = event.target.value;
		layerGroupCountries.eachLayer(function(layer){
			layer.eachLayer(function(countryLayer){
				if(countryLayer.feature.properties.NAME_EN == countryName){
					//removeStatesOfCurrentCountry();
					//removeCitiesOfCurrentCountry();
					if(event.target.checked){
						selectCountry(countryLayer);
						showStatesOfCountry(countryLayer);
						showCitiesOfCountry(countryLayer);
					}else{
						unselectCountry(countryLayer);
						removeStatesOfCountry(countryLayer);
						removeCitiesOfCountry(countryLayer);
					}
				}
			});
		});
	}

	function highlightCountry(layer) {
		layer.setStyle({
			weight: 4,
			color: '#222222',
			dashArray: '',
			fillOpacity: 0.0
		});
	}

	function unselectCountry(country){
		resetHighlightCountry(country);
		currentCountry = undefined;
		layerGroupCountriesSelected.removeLayer(country);
		console.log(layerGroupCountries);
	}

	function resetHighlightCountry(layer) {
		layerGroupCountries.eachLayer(function (l) {
    	l.resetStyle(layer);
		});
	}

	// States and Provinces

	function showStatesOfCountry(country){
		var layerStates = L.geoJSON(states[0].features, {
			style: styleState,
			filter: function(f){
				return f.properties.geonunit === country.feature.properties.NAME_EN;
			},
			onEachFeature: onEachState
		});
		layerStates.country = country.feature.properties.NAME_EN;
		layerGroupStates.addLayer(layerStates);
	}

	function removeStatesOfCountry(country){
		layerGroupStates.eachLayer(function(layerStates) {
			if(layerStates.country === country.feature.properties.NAME_EN){
				layerGroupStates.removeLayer(layerStates);
			}
		});
	}

	function styleState(feature) {
		return {
			weight: 1,
			//opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.0,
			//fillColor: '#6abf69'
		};
	}

	function onEachState(feature, layer) {
		layer.on('click', function(event){
			if(!quizMode){
				selectState(event.target);
			}
		});
	}

	function selectState(layer){
		if(currentState != undefined){
			resetHighlightState(currentState);
		}
		currentState = layer;
		highlightState(layer);
		updateDetails();
	}

	function highlightState(layer) {
		layer.setStyle({
			weight: 5,
			color: '#81d4fa',
			dashArray: '',
			fillOpacity: 0.0
		});
	}

	function unselectState(state){
		resetHighlightState(state);
		currentState = undefined;
	}

  function resetHighlightState(layer) {
		layerGroupStates.eachLayer(function (l) {
    	l.resetStyle(layer);
		});
	}

	// Cities

	function showCitiesOfCountry(countryLayer){
		var layerCities = L.geoJSON(cities[0].features, {
			pointToLayer: function(feature, latlng) {
				return new L.marker(latlng, {
					icon: getCityIcon(feature),
				});
      },
			onEachFeature: onEachCity,
			filter: function(f){
				return f.properties.ADM0NAME === countryLayer.feature.properties.NAME_EN && f.properties.RANK_MIN >= 9;
			}
		});
		layerCities.country = countryLayer.feature.properties.NAME_EN;
		layerGroupCities.addLayer(layerCities);
	}

	function removeCitiesOfCountry(countryLayer){
		layerGroupCities.eachLayer(function(layerCities) {
			if(layerCities.country === countryLayer.feature.properties.NAME_EN){
				layerGroupCities.removeLayer(layerCities);
			}
		});
	}

	function onEachCity(feature, layer) {
		layer.on('click', function(event){
			if(!quizMode){
				selectCity(event.target);
			}
		});
	}

	function selectCity(layer){
		unselectState(currentState);
		layerGroupStates.eachLayer(function(layerStates){
			layerStates.eachLayer(function(layerState){
				if(layerState.feature.properties.name == layer.feature.properties.ADM1NAME){
					selectState(layerState);
				}
			});
		});
		if(currentCity != undefined){
			resetHighlightCity(currentCity);
		}
		currentCity = layer;
		highlightCity(layer);
		updateDetails();
	}

	function highlightCity(layer) {
    //layer = e.target;
		/*layer.setStyle({
			weight: 8,
			radius: 1,
			color: '#81d4fa',
			dashArray: '',
			fillOpacity: 0.0
		});*/

		layer.setIcon(new L.Icon({
		  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
		  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor:   [12 ,41],
		  popupAnchor: [1, -34],
		  shadowSize: [41, 41]
		}));

		/*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}*/
	}

	function unselectCity(city){
		resetHighlightCity(city);
		currentCity = undefined;
	}

  function resetHighlightCity(layer) {
		if(layer != undefined){
			layer.setIcon(getCityIcon(layer.feature));
		}
	}

	function getCityIcon(feature){
		return new L.Icon.Default({
			iconSize: [25, 41],
			iconAnchor:   [12, 41]
		})
	}

	// Quiz

	var quizCountries;
	var quizQuestionTypes;

	function startQuiz(){
		if(layerGroupCountriesSelected.getLayers().length == 0){
			alert("Please select a country");
			return;
		}
		quizMode = true;

		document.getElementById('quiz-setup').style.display = "none";
		document.getElementById('quiz-panel').style.display = "block";

		var checkedQuestionTypeCheckBoxes = document.querySelectorAll('input[name=quiz-setup-question-type]:checked');
		quizQuestionTypes = [];

		for (var i = 0; i < checkedQuestionTypeCheckBoxes.length; i++) {
  		quizQuestionTypes.push(checkedQuestionTypeCheckBoxes[i].value);
		}

		generateQuestions();
		nextQuestion();
	}

	var tasks;

	function generateQuestions(){
		tasks = [];
		layerGroupCountriesSelected.eachLayer(function(layerCountry){
			if(quizQuestionTypes.includes("country-name")){
				var countryNameTask = {
					"type": "country-name",
					"country": layerCountry
				}
				tasks.push(countryNameTask);
			}
			if(quizQuestionTypes.includes("country-population")){
				var countryPopulationTask = {
					"type": "country-population",
					"country": layerCountry
				}
				tasks.push(countryPopulationTask);
			}
			layerGroupStates.eachLayer(function(layerStates){
				layerStates.eachLayer(function(layerState){
					if(layerCountry.feature.properties.NAME_EN == layerState.feature.properties.geonunit){
						if(quizQuestionTypes.includes("state-name")){
							var stateNameTask = {
								"type": "state-name",
								"country": layerCountry,
								"state": layerState
							}
							tasks.push(stateNameTask);
						}
						layerGroupCities.eachLayer(function(layerCities){
							layerCities.eachLayer(function(layerCity){
								if(layerCity.feature.properties.ADM1NAME == layerState.feature.properties.name){
									if(quizQuestionTypes.includes("city-name")){
										var cityNameTask = {
											"type": "city-name",
											"country": layerCountry,
											"state": layerState,
											"city": layerCity
										}
										tasks.push(cityNameTask);
									}
								}
							});
						});
					}
				});
			});
		});
	}

	var currentTask;

	function nextQuestion(){
		if(tasks.length == 0){
			finishQuiz();
			return;
		}
		document.getElementById("quiz-panel-input").value = "";
		currentTask = tasks.shift();
		switch(currentTask.type){
			case "country-name":
				selectCountry(currentTask.country);
				document.getElementById("quiz-panel-question").innerHTML = "What is the name of the selected country?";
				break;
			case "country-population":
				selectCountry(currentTask.country);
				document.getElementById("quiz-panel-question").innerHTML = "What is the population of the selected country in " + currentTask.country.feature.properties.POP_YEAR + "?";
				break;
			case "state-name":
				selectCountry(currentTask.country);
				selectState(currentTask.state);
				document.getElementById("quiz-panel-question").innerHTML = "What is the name of the selected state?";
				break;
			case "city-name":
				selectCountry(currentTask.country);
				selectState(currentTask.state);
				selectCity(currentTask.city)
				document.getElementById("quiz-panel-question").innerHTML = "What is the name of the selected city?";
				break;
		}
	}

	function checkAnswer(event){
		event.preventDefault();
		switch(currentTask.type){
			case "country-name":
				if(document.getElementById("quiz-panel-input").value == currentTask.country.feature.properties.NAME_EN){
					alert("correct");
				}else{
					alert("false, the correct answer is: " + currentTask.country.feature.properties.NAME_EN);
				}
				break;
			case "country-population":
				if(Math.abs(document.getElementById("quiz-panel-input").value.replace(/,/g, '') - currentTask.country.feature.properties.POP_EST) <= 1000000){
					alert("correct, the exact answer is: " + numberWithCommas(currentTask.country.feature.properties.POP_EST));
				}else{
					alert("false, the correct answer is: " + numberWithCommas(currentTask.country.feature.properties.POP_EST));
				}
				break;
			case "state-name":
				if(document.getElementById("quiz-panel-input").value == currentTask.state.feature.properties.name){
					alert("correct");
				}else{
					alert("false, the correct answer is: " + currentTask.state.feature.properties.name);
				}
				break;
			case "city-name":
				if(document.getElementById("quiz-panel-input").value == currentTask.city.feature.properties.name_en){
					alert("correct");
				}else{
					alert("false, the correct answer is: " + currentTask.city.feature.properties.name_en);
				}
				resetHighlightCity(currentTask.city);
				break;
		}
		nextQuestion();
	}

	function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}

	function finishQuiz(){
		//unselectCountry(currentCountry);
		unselectState(currentState);
		unselectCity(currentCity);
		//removeStatesOfCurrentCountry();
		//removeCitiesOfCurrentCountry();
		document.getElementById('quiz-panel').style.display = "none";
		document.getElementById('quiz-setup').style.display = "block";
		quizMode = false;
	}

	// Country Quiz

	function checkCountryName(event) {
			event.preventDefault();
			if(currentCountry.feature.properties.NAME_EN == document.getElementById("country-name").value){
				alert('correct');
				document.getElementById("country-name").value = "";
				nextCountry();
			}else{
				alert('wrong');
			}
	}

	function nextCountry(){
		if(currentCountry != undefined){
			resetHighlightCountry(currentCountry);
		}

		if(quizCountries.length > 0){
			var randomValue = currentCountry;
			do{
				randomValue = quizCountries[parseInt(Math.random() * quizCountries.length)]
			}while(quizCountries.length > 1 && randomValue == currentCountry)

			/*currentCountry = randomValue;
			highlightCountry(randomValue);
			updateDetails();*/

			selectCountry(randomValue);
		}
	}

	// State Quiz

	function checkStateName(event) {
			event.preventDefault();
			if(currentState.feature.properties.name == document.getElementById("state-name").value){
				alert('correct');
				document.getElementById("state-name").value = "";
				nextState();
			}else{
				alert('wrong');
			}
	}

	function nextState(){
		if(currentState != undefined){
			resetHighlightState(currentState);
		}

		var values = [];
		layerGroupStates.eachLayer(function (layer) {
			layer.eachLayer(function(layer2) {
  			values.push(layer2);
			});
		});

		if(values.length > 0){
			var randomValue = currentState;
			do{
				randomValue = values[parseInt(Math.random() * values.length)]
			}while(values.length > 1 && randomValue == currentState)

			/*currentState = randomValue;
			highlightState(randomValue);
			updateDetails();*/

			selectState(randomValue);
		}
	}

	// City Quiz

	function checkCityName(event) {
			event.preventDefault();
			if(currentCity.feature.properties.NAME == document.getElementById("city-name").value){
				alert('correct\npopulation: ' + currentCity.feature.properties.POP_MAX);
				document.getElementById("city-name").value = "";
				nextCity();
			}else{
				alert('wrong');
			}
	}

	function nextCity(){
		if(currentCity != undefined){
			resetHighlightCity(currentCity);
		}

		var values = [];
		layerGroupCities.eachLayer(function (layer) {
			layer.eachLayer(function(layer2) {
  			values.push(layer2);
			});
		});

		if(values.length > 0){
			var randomValue = currentCity;
			do{
				randomValue = values[parseInt(Math.random() * values.length)]
			}while(values.length > 1 && randomValue == currentCity)

			/*currentCity = randomValue;
			highlightCity(randomValue);
			updateDetails();*/

			selectCity(randomValue);
		}
	}

	// General

	/*function updateInfo(e){
		layer = e.target;
		info.update(layer.feature.properties);
		highlightState(e);
	}*/

	const myEventForwarder = new L.eventForwarder({
	  // ref to leaflet map
	  map: map,
	  // events to forward
	  events: {
	    click: true,
	    mousemove: true,
	    mouseout: true
	  },
	  // throttle options for mousemove events (same as underscore.js)
	  throttleMs: 100,
	  throttleOptions: {
	    leading: true,
	    trailing: false
	  }
	});

	myEventForwarder.enable();

	map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');

</script>



</body>
</html>
